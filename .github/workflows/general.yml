name: 'General Checks'

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - dev

permissions:
  contents: write
  pull-requests: read

jobs:
  check-branch-policy:
    name: Check Branch push
    runs-on: ubuntu-latest
    steps:
      - name: Block push from main and dev
        if: github.event_name == 'push'
        run: |
          current_branch="${{ github.ref_name }}"
          echo "Verifying push: $current_branch"
          
          if [[ "$current_branch" == "main" || "$current_branch" == "dev" ]]; then
            echo "You push on $current_branch forbiden."
            exit 1
          fi
          echo "Can push."

  commit-and-style:
    name: Commit Message, C++ Style & Lint
    runs-on: ubuntu-latest
    needs: check-branch-policy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools (clang-format, cpplint)
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install --user cpplint clang-format
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check Commit Message
        if: github.event_name == 'push'
        run: |
          msgs=$(git log --format=%s ${{ github.event.before }}..${{ github.event.after }})
          bad_commits=$(echo "$msgs" | grep -vE '^(feat|fix|docs): |^Merge ' || true)
          
          if [ -n "$bad_commits" ]; then
            echo "Bad commit message :"
            echo "$bad_commits"
            exit 1
          fi
          echo "Commit message correct"

      - name: Check C++ Code Style (clang-format)
        run: |
          echo "Check the coding style with clang-format"
          find src tests test_input -type f \( -name "*.cpp" -o -name "*.hpp" \) \
            ! -name "*sqlite3*" \
            ! -path "src/Network/*" \
            -exec clang-format --dry-run --Werror {} +

      - name: Check C++ Code Style (cpplint)
        run: |
          echo "Check the coding style with cpplint"
          cpplint --recursive \
            --exclude=src/Network/Database/sqlite3.c \
            --exclude=src/Network/Database/sqlite3.h \
            --exclude=src/Network/* \
            --exclude=Network/* \
            src tests Network test_input

  run-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: commit-and-style
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Unit Tests
        run: |
          chmod +x launch_project/units_tests_launch.sh
          ./launch_project/units_tests_launch.sh

  push_to_mirror:
    name: push_to_mirror
    runs-on: ubuntu-latest
    needs: run-tests
    if: github.event_name == 'push'
    steps:
      - name: push_to_mirror
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url:
            "git@github.com:EpitechPGE3-2025/G-CPP-500-PAR-5-2-rtype-17.git"
          ssh_private_key:
            ${{ secrets.GIT_SSH_PRIVATE_KEY }}